sudo: required
services:
- docker
matrix:
  include:
  - language: php
    php:
    - 7.2
    cache:
      directories:
      - vendor
      - "$HOME/.composer/cache"
    install:
    - rm composer.lock
    - composer update --no-scripts
    - cp .env.testing .env
    - php artisan clear-compiled
    - php artisan env
    - wget -q https://github.com/firefly-iii/test-data/raw/master/storage/database.sqlite
      -O storage/database/database.sqlite
    - mkdir -p build/logs
    script:
    - "./vendor/bin/phpunit -c phpunit.coverage.xml"
    after_success:
    - travis_retry php vendor/bin/php-coveralls -x storage/build/clover-all.xml
    branches:
      only:
      - develop
      - master
  - language: bash
    script:
    - docker run --rm --privileged multiarch/qemu-user-static:register --reset
    - docker build -t odyno/rpi-firefly-iii .
    - |
      if [ "$TRAVIS_BRANCH" == "rpi-docker" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
        #docker login -u="$DOCKER_USER" -p="$DOCKER_PASS"
        #TAG=$(grep "ENV FIREFLY_III_VERSION" Dockerfile | awk 'NF>1{print $NF}')
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
        TAG=$FIREFLY_III_VERSION
        docker tag odyno/rpi-firefly-iii odyno/rpi-firefly-iii:$TAG
        docker push odyno/rpi-firefly-iii:$TAG
        docker push odyno/rpi-firefly-iii
      fi
    branches:
      only:
      - rpi-docker
env:
  global:
  - FIREFLY_III_VERSION: 0.0.1
  - DOCKER_USER: odyno
  - secure: jGn6ot3eBReXBTYzeH8SXf9Z5rCzLTqgJMEymutZPO2WcuWTbLZ1Xew1ekuGjrOJN9wBcmhGrt46goQj+G2/DOSxhdL4H82tJ+rEpssBnO0Sf6KBzu2TC0qobNh46UYnBKdNzBGdXHltRNQ8rmnragm31ENqXJ/c/iPep4/4r7X35XPN6w4wTdomDnpGwyCby5VZ6IxCy3lLAJa0ysslvPkyyFJf/+B9RJmI3xFDsMAgVSbVGxOqogM4mpDhWdF0pWsRT6WN/fWWoCmM8QEcPhYoKRrtsAWtygYyUx/4cfsUED466IOnnwE6T7Ox8NS8ULerrKaL89fjTw3FyLvS9zQ3c0ikucfF47w4OyVjG3ek1BAMKh4neq8H+jmh/Z8OTYX9PCK1He7xn75AGgu/Rm/k/m3ZiYrvWPf30wbLNVmYMSgOLnWpzcaG/NKNHU2PQDJDlglHMbJX+qCtVbmHFEGYoYM8YuiQowrDGyMAYtrVu58FThLxj26/jpbJa3xyEC9gnyVbmkv6h+ScPb50E4ESuyHXtaAnzESSYdLjJ66pLbKCaYLuGCvGOMNQK+d0i86qcUqwht/OmDwldwRPNlqLKg2CaJ2OikkGH6hQSs4L7EtzVgHERKGluZ/nnb7xvXO3yRVsYuEiBjjxOIUAziEKR6XkEOiq7tYmJLsM+IY=
